<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>éŠ€æ²³å¤§ãã•ä½“æ„Ÿãƒãƒƒãƒ—</title>
	<meta name="description" content="ã€ŒéŠ€æ²³å¤§ãã•ä½“æ„Ÿãƒãƒƒãƒ—ã€ã¯éŠ€æ²³ã®å¤§ãã•ã¨ä»–ã®éŠ€æ²³ã¾ã§ã®è·é›¢ã‚’ç¸®å°ºã—ã¦åœ°å›³ä¸Šã«è¡¨ç¤ºã—ã¾ã™ã€‚å®‡å®™ç©ºé–“ã®åºƒå¤§ã•ã‚’è¦–è¦šçš„ã«ç†è§£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚">
	<meta property="og:title" content="éŠ€æ²³å¤§ãã•ä½“æ„Ÿãƒãƒƒãƒ—">
	<meta property="og:description" content="ã€ŒéŠ€æ²³å¤§ãã•ä½“æ„Ÿãƒãƒƒãƒ—ã€ã¯éŠ€æ²³ã®å¤§ãã•ã¨ä»–ã®éŠ€æ²³ã¾ã§ã®è·é›¢ã‚’ç¸®å°ºã—ã¦åœ°å›³ä¸Šã«è¡¨ç¤ºã—ã¾ã™ã€‚å®‡å®™ç©ºé–“ã®åºƒå¤§ã•ã‚’è¦–è¦šçš„ã«ç†è§£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚">

	<!-- Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-89GN3KL35R"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());
		gtag('config', 'G-89GN3KL35R');
	</script>

	<!-- MapLibre GL JS -->
	<script src="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.js"></script>
	<link href="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.css" rel="stylesheet" />

	<!-- Turf.js -->
	<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		}

		#map {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 100%;
		}

		.control-panel {
			position: absolute;
			top: 20px;
			left: 20px;
			background: white;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			z-index: 1000;
			min-width: 300px;
		}

		.control-panel h2 {
			margin-bottom: 15px;
			font-size: 18px;
			color: #333;
		}

		.input-group {
			margin-bottom: 15px;
		}

		.input-group label {
			display: block;
			margin-bottom: 5px;
			font-size: 14px;
			color: #555;
		}

		.input-group input {
			width: 100%;
			padding: 8px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 14px;
		}

		.input-group input:focus {
			outline: none;
			border-color: #4CAF50;
		}

		.update-btn {
			width: 100%;
			padding: 10px;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 4px;
			font-size: 16px;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		.update-btn:hover {
			background-color: #45a049;
		}

		.map-selector {
			margin-bottom: 15px;
		}

		.map-selector label {
			display: block;
			margin-bottom: 5px;
			font-size: 14px;
			color: #555;
		}

		.map-selector select {
			width: 100%;
			padding: 8px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 14px;
			background-color: white;
			cursor: pointer;
		}

		.map-selector select:focus {
			outline: none;
			border-color: #4CAF50;
		}

		.legend {
			position: absolute;
			bottom: 30px;
			right: 20px;
			background: white;
			padding: 15px;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			z-index: 1000;
		}

		.legend h3 {
			margin-bottom: 10px;
			font-size: 14px;
			color: #333;
		}

		.legend-item {
			display: flex;
			align-items: center;
			margin-bottom: 5px;
			font-size: 12px;
		}

		.legend-color {
			width: 20px;
			height: 3px;
			margin-right: 8px;
			border-radius: 2px;
		}

		.info-text {
			font-size: 12px;
			color: #666;
			margin-top: 10px;
		}

		.out-of-range {
			position: absolute;
			top: 20px;
			right: 20px;
			background: white;
			padding: 15px;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			z-index: 1000;
			max-width: 300px;
		}

		.out-of-range h3 {
			margin-bottom: 10px;
			font-size: 14px;
			color: #333;
		}

		.out-of-range-item {
			font-size: 12px;
			color: #666;
			margin-bottom: 5px;
			padding: 5px;
			border-left: 3px solid;
			padding-left: 8px;
		}

		.out-of-range-empty {
			font-size: 12px;
			color: #999;
			font-style: italic;
		}

		.panel-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}

		.panel-header h2,
		.panel-header h3 {
			margin-bottom: 0;
		}

		.toggle-btn {
			background: none;
			border: none;
			font-size: 18px;
			cursor: pointer;
			padding: 5px;
			color: #666;
			transition: color 0.3s;
		}

		.toggle-btn:hover {
			color: #333;
		}

		.panel-content {
			transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
			overflow: hidden;
		}

		.panel-content.collapsed {
			max-height: 0 !important;
			opacity: 0;
			margin: 0;
			padding: 0;
		}

		.fullscreen-btn {
			position: absolute;
			bottom: 30px;
			left: 20px;
			background: white;
			border: none;
			border-radius: 4px;
			padding: 10px 15px;
			font-size: 20px;
			cursor: pointer;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			z-index: 1000;
			transition: background-color 0.3s;
		}

		.fullscreen-btn:hover {
			background-color: #f0f0f0;
		}
	</style>
</head>

<body>
	<div id="map"></div>

	<a href="index.html" class="home-link" title="ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹">ğŸ  ãƒ›ãƒ¼ãƒ </a>

	<button class="fullscreen-btn" onclick="toggleFullscreen()" title="å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰">â›¶</button>
	<button class="location-btn" onclick="setCurrentLocation()" title="ç¾åœ¨åœ°ã‚’ä¸­å¿ƒã«ã™ã‚‹">ğŸ“</button>

	<div class="control-panel">
		<div class="panel-header">
			<h2>ğŸŒŒ éŠ€æ²³ç³»å¤§ãã•ä½“æ„Ÿãƒãƒƒãƒ—</h2>
			<button class="toggle-btn" onclick="togglePanel('controlContent')" title="ãƒ‘ãƒãƒ«ã‚’æŠ˜ã‚ŠãŸãŸã‚€">â–¼</button>
		</div>

		<div id="controlContent" class="panel-content">
			<div class="map-selector">
				<label for="mapStyle">èƒŒæ™¯åœ°å›³:</label>
				<select id="mapStyle" onchange="changeMapStyle()">
					<option value="osm">OpenStreetMap</option>
					<option value="gsi-std">åœ°ç†é™¢åœ°å›³(æ¨™æº–)</option>
					<option value="gsi-pale">åœ°ç†é™¢åœ°å›³(æ·¡è‰²)</option>
					<option value="gsi-blank">åœ°ç†é™¢åœ°å›³(ç™½åœ°å›³)</option>
					<option value="gsi-photo">åœ°ç†é™¢åœ°å›³(è¡›æ˜Ÿå†™çœŸ)</option>
				</select>
			</div>

			<div class="input-group">
				<label for="milkyWayDiameter">éŠ€æ²³ç³»ã®ç›´å¾„ (km):</label>
				<input type="number" id="milkyWayDiameter" value="10" step="1" min="0.1">
			</div>

			<button class="update-btn" onclick="updateGalaxies()">æç”»æ›´æ–°</button>

			<div class="info-text">
				â„¹ï¸ éŠ€æ²³ç³»ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä½ç½®ã‚’å¤‰æ›´ã§ãã¾ã™
			</div>
		</div>
	</div>

	<div class="out-of-range" id="outOfRange">
		<div class="panel-header">
			<h3>ğŸ“ æç”»ç¯„å›²å¤–ã®éŠ€æ²³</h3>
			<button class="toggle-btn" onclick="togglePanel('outOfRangeContent')" title="ãƒ‘ãƒãƒ«ã‚’æŠ˜ã‚ŠãŸãŸã‚€">â–¼</button>
		</div>
		<div id="outOfRangeContent" class="panel-content">
			<div id="outOfRangeList">
				<div class="out-of-range-empty">æƒ…å ±ãªã—</div>
			</div>
		</div>
	</div>

	<div class="legend">
		<div class="panel-header">
			<h3>éŠ€æ²³ãƒ»éŠ€æ²³å›£</h3>
			<button class="toggle-btn" onclick="togglePanel('legendContent')" title="ãƒ‘ãƒãƒ«ã‚’æŠ˜ã‚ŠãŸãŸã‚€">â–¼</button>
		</div>
		<div id="legendContent" class="panel-content">
			<div class="legend-item">
				<div class="legend-color" style="background-color: #FF6B9D;"></div>
				<span>å¤§ãƒã‚¼ãƒ©ãƒ³é›² (16.3ä¸‡å…‰å¹´)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #9D6BFF;"></div>
				<span>å°ãƒã‚¼ãƒ©ãƒ³é›² (20ä¸‡å…‰å¹´)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #00CED1;"></div>
				<span>ã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€éŠ€æ²³ (254ä¸‡å…‰å¹´)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #FF8C00;"></div>
				<span>ã•ã‚“ã‹ãåº§éŠ€æ²³ (273ä¸‡å…‰å¹´)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #DC143C;"></div>
				<span>ã‚±ãƒ³ã‚¿ã‚¦ãƒ«ã‚¹åº§A (1370ä¸‡å…‰å¹´)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #9370DB;"></div>
				<span>ãŠã¨ã‚åº§éŠ€æ²³å›£ (5350ä¸‡å…‰å¹´)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #4682B4;"></div>
				<span>ã‹ã¿ã®ã‘åº§éŠ€æ²³å›£ (3.2å„„å…‰å¹´)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #2E8B57;"></div>
				<span>ãŠãŠãã¾åº§éŠ€æ²³å›£ (3.9å„„å…‰å¹´)</span>
			</div>
		</div>
	</div>

	<script>
		// ========== å®šæ•°å®šç¾© ==========
		// éŠ€æ²³ç³»ã®å®Ÿéš›ã®ç›´å¾„ï¼ˆå…‰å¹´ï¼‰
		const MILKY_WAY_DIAMETER_LY = 105700;

		// 1å…‰å¹´ï¼ˆkmï¼‰
		const LIGHT_YEAR_IN_KM = 9460730472580.8;

		// åœ°çƒã®èµ¤é“å‘¨é•·ï¼ˆkmï¼‰
		const EARTH_CIRCUMFERENCE_KM = 40075;

		// éŠ€æ²³ãƒ‡ãƒ¼ã‚¿: åå‰ã€è·é›¢ï¼ˆå…‰å¹´ï¼‰ã€ç›´å¾„ï¼ˆå…‰å¹´ï¼‰ã€è‰²ã€ç¨®åˆ¥ã€ç™ºè¦‹å¹´
		const GALAXIES = [
			{ name: 'å¤§ãƒã‚¼ãƒ©ãƒ³é›²', distanceLY: 163000, diameterLY: 14000, color: '#FF6B9D', type: 'dwarf', discoveryYear: null },
			{ name: 'å°ãƒã‚¼ãƒ©ãƒ³é›²', distanceLY: 200000, diameterLY: 7000, color: '#9D6BFF', type: 'dwarf', discoveryYear: null },
			{ name: 'ã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€éŠ€æ²³', distanceLY: 2537000, diameterLY: 220000, color: '#00CED1', type: 'spiral', discoveryYear: 964 },
			{ name: 'ã•ã‚“ã‹ãåº§éŠ€æ²³', distanceLY: 2730000, diameterLY: 60000, color: '#FF8C00', type: 'spiral', discoveryYear: 1784 },
			{ name: 'ã‚±ãƒ³ã‚¿ã‚¦ãƒ«ã‚¹åº§A', distanceLY: 13700000, diameterLY: 60000, color: '#DC143C', type: 'elliptical', discoveryYear: 1826 },
			{ name: 'ãŠã¨ã‚åº§éŠ€æ²³å›£', distanceLY: 53500000, diameterLY: 0, color: '#9370DB', type: 'cluster', discoveryYear: 1781 },
			{ name: 'ã‹ã¿ã®ã‘åº§éŠ€æ²³å›£', distanceLY: 320000000, diameterLY: 0, color: '#4682B4', type: 'cluster', discoveryYear: 1785 },
			{ name: 'ãŠãŠãã¾åº§éŠ€æ²³å›£', distanceLY: 390000000, diameterLY: 0, color: '#2E8B57', type: 'cluster', discoveryYear: 1900 }
		];

		// åˆæœŸä¸­å¿ƒåº§æ¨™: ã¿ã•ã¨å¤©æ–‡å°
		const INITIAL_CENTER = [135.40660, 34.14466]; // [çµŒåº¦, ç·¯åº¦]

		// ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ==========
		let map;
		let milkyWayMarker;
		let milkyWayCoordinates = INITIAL_CENTER;

		// åœ°å›³ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
		const MAP_STYLES = {
			'osm': {
				version: 8,
				glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
				sources: {
					'osm': {
						type: 'raster',
						tiles: [
							'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
							'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
							'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
						],
						tileSize: 256,
						attribution: 'Â© OpenStreetMap contributors'
					}
				},
				layers: [{
					id: 'osm',
					type: 'raster',
					source: 'osm',
					minzoom: 0,
					maxzoom: 19
				}]
			},
			'gsi-std': {
				version: 8,
				glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
				sources: {
					'gsi-std': {
						type: 'raster',
						tiles: [
							'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'
						],
						tileSize: 256,
						attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>'
					}
				},
				layers: [{
					id: 'gsi-std',
					type: 'raster',
					source: 'gsi-std',
					minzoom: 0,
					maxzoom: 18
				}]
			},
			'gsi-pale': {
				version: 8,
				glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
				sources: {
					'gsi-pale': {
						type: 'raster',
						tiles: [
							'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png'
						],
						tileSize: 256,
						attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>'
					}
				},
				layers: [{
					id: 'gsi-pale',
					type: 'raster',
					source: 'gsi-pale',
					minzoom: 0,
					maxzoom: 18
				}]
			},
			'gsi-blank': {
				version: 8,
				glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
				sources: {
					'gsi-blank': {
						type: 'raster',
						tiles: [
							'https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png'
						],
						tileSize: 256,
						attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>'
					}
				},
				layers: [{
					id: 'gsi-blank-layer',
					type: 'raster',
					source: 'gsi-blank',
					minzoom: 0,
					maxzoom: 14
				}]
			},
			'gsi-photo': {
				version: 8,
				glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
				sources: {
					'gsi-photo': {
						type: 'raster',
						tiles: [
							'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'
						],
						tileSize: 256,
						attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>'
					}
				},
				layers: [{
					id: 'gsi-photo',
					type: 'raster',
					source: 'gsi-photo',
					minzoom: 0,
					maxzoom: 18
				}]
			}
		};

		// ========== ç¨®åˆ¥ã®æ—¥æœ¬èªå ==========
		const TYPE_NAMES = {
			'dwarf': 'çŸ®å°éŠ€æ²³',
			'spiral': 'æ¸¦å·»éŠ€æ²³',
			'elliptical': 'æ¥•å††éŠ€æ²³',
			'cluster': 'éŠ€æ²³å›£'
		};

		// ========== å…‰ã®åˆ°é”æ™‚é–“ã®è¨ˆç®— ==========
		function calculateLightTravelTime(distanceLY) {
			if (distanceLY < 1) {
				return `${(distanceLY * 365.25).toFixed(2)}æ—¥`;
			} else if (distanceLY < 1000) {
				return `${distanceLY.toFixed(2)}å¹´`;
			} else if (distanceLY < 1000000) {
				return `${(distanceLY / 1000).toFixed(2)}åƒå¹´`;
			} else if (distanceLY < 1000000000) {
				return `${(distanceLY / 1000000).toFixed(2)}ç™¾ä¸‡å¹´`;
			} else {
				return `${(distanceLY / 1000000000).toFixed(2)}å„„å¹´`;
			}
		}

		// ========== åˆæœŸåŒ– ==========
		function init() {
			// åœ°å›³ã®åˆæœŸåŒ–
			map = new maplibregl.Map({
				container: 'map',
				style: MAP_STYLES['osm'],
				center: INITIAL_CENTER,
				zoom: 14
			});

			// åœ°å›³ã®èª­ã¿è¾¼ã¿å®Œäº†å¾Œ
			map.on('load', () => {
				// éŠ€æ²³ç³»ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆ
				createMilkyWayMarker();

				// åˆæœŸæç”»
				updateGalaxies();
			});

			// Enterã‚­ãƒ¼ã§æç”»æ›´æ–°
			document.getElementById('milkyWayDiameter').addEventListener('keypress', (e) => {
				if (e.key === 'Enter') updateGalaxies();
			});
		}

		// ========== éŠ€æ²³ç³»ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆ ==========
		function createMilkyWayMarker() {
			// ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼è¦ç´ ã®ä½œæˆ
			const el = document.createElement('div');
			el.style.width = '40px';
			el.style.height = '40px';
			el.style.borderRadius = '50%';
			el.style.background = 'radial-gradient(circle, #FFD700, #FFA500)';
			el.style.border = '3px solid white';
			el.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.8)';
			el.style.cursor = 'move';

			// ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆ
			milkyWayMarker = new maplibregl.Marker({
				element: el,
				draggable: true
			})
				.setLngLat(milkyWayCoordinates)
				.addTo(map);

			// ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
			milkyWayMarker.on('dragend', () => {
				milkyWayCoordinates = milkyWayMarker.getLngLat().toArray();
				updateGalaxies();
			});
		}

		// ========== éŠ€æ²³ã®æ›´æ–°ãƒ»æç”» ==========
		function updateGalaxies() {
			const milkyWayDiameterKm = parseFloat(document.getElementById('milkyWayDiameter').value);

			if (isNaN(milkyWayDiameterKm) || milkyWayDiameterKm <= 0) {
				alert('æœ‰åŠ¹ãªéŠ€æ²³ç³»ã®ç›´å¾„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
				return;
			}

			// ç¸®å°ºä¿‚æ•°ã®è¨ˆç®—
			const actualMilkyWayDiameterKm = MILKY_WAY_DIAMETER_LY * LIGHT_YEAR_IN_KM;
			const scale = milkyWayDiameterKm / actualMilkyWayDiameterKm;

			console.log(`ç¸®å°º: éŠ€æ²³ç³» ${milkyWayDiameterKm} km`);
			console.log(`ç¸®å°ºä¿‚æ•°: ${scale.toExponential(2)}`);

			// ç¯„å›²å¤–ã®éŠ€æ²³ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
			window.outOfRangeGalaxies = [];

			// æ—¢å­˜ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤
			GALAXIES.forEach(galaxy => {
				const distanceLayerId = `distance-${galaxy.name}`;
				const distanceSourceId = `distance-source-${galaxy.name}`;
				const galaxyLayerId = `galaxy-${galaxy.name}`;
				const galaxySourceId = `galaxy-source-${galaxy.name}`;
				const labelLayerId = `label-${galaxy.name}`;
				const labelSourceId = `label-source-${galaxy.name}`;

				if (map.getLayer(distanceLayerId)) {
					map.removeLayer(distanceLayerId);
				}
				if (map.getSource(distanceSourceId)) {
					map.removeSource(distanceSourceId);
				}
				if (map.getLayer(galaxyLayerId)) {
					map.removeLayer(galaxyLayerId);
				}
				if (map.getSource(galaxySourceId)) {
					map.removeSource(galaxySourceId);
				}
				if (map.getLayer(labelLayerId)) {
					map.removeLayer(labelLayerId);
				}
				if (map.getSource(labelSourceId)) {
					map.removeSource(labelSourceId);
				}
			});

			// éŠ€æ²³ç³»æœ¬ä½“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚å‰Šé™¤
			if (map.getLayer('milky-way-body')) {
				map.removeLayer('milky-way-body');
			}
			if (map.getSource('milky-way-body-source')) {
				map.removeSource('milky-way-body-source');
			}

			// éŠ€æ²³ç³»æœ¬ä½“ã‚’æç”»
			const milkyWayRadiusKm = milkyWayDiameterKm / 2;
			const milkyWayCircle = turf.circle(milkyWayCoordinates, milkyWayRadiusKm, {
				steps: 128,
				units: 'kilometers'
			});

			map.addSource('milky-way-body-source', {
				type: 'geojson',
				data: milkyWayCircle
			});

			map.addLayer({
				id: 'milky-way-body',
				type: 'fill',
				source: 'milky-way-body-source',
				paint: {
					'fill-color': '#FFD700',
					'fill-opacity': 0.4
				}
			});

			// å„éŠ€æ²³ã®è·é›¢å††ã¨éŠ€æ²³æœ¬ä½“ã‚’æç”»
			GALAXIES.forEach(galaxy => {
				// éŠ€æ²³ã¾ã§ã®å®Ÿéš›ã®è·é›¢ï¼ˆkmï¼‰
				const actualDistanceKm = galaxy.distanceLY * LIGHT_YEAR_IN_KM;

				// åœ°å›³ä¸Šã§ã®è·é›¢ï¼ˆkmï¼‰
				const mapDistanceKm = actualDistanceKm * scale;

				// è·é›¢ãŒ20,000kmã‚’è¶…ãˆã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã€æƒ…å ±ã‚’è¨˜éŒ²
				if (mapDistanceKm > 20000) {
					const timesAroundEarth = mapDistanceKm / EARTH_CIRCUMFERENCE_KM;
					console.log(`${galaxy.name}: è·é›¢ ${mapDistanceKm.toFixed(2)} km (åœ°çƒ${timesAroundEarth.toFixed(2)}å‘¨åˆ†) - è¡¨ç¤ºç¯„å›²å¤–ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—`);

					// ç¯„å›²å¤–ã®éŠ€æ²³æƒ…å ±ã‚’ä¿å­˜
					window.outOfRangeGalaxies.push({
						name: galaxy.name,
						color: galaxy.color,
						distanceKm: mapDistanceKm,
						timesAroundEarth: timesAroundEarth
					});

					return;
				}

				// è·é›¢å††ã‚’ç”Ÿæˆ
				const distanceCircle = turf.circle(milkyWayCoordinates, mapDistanceKm, {
					steps: 128,
					units: 'kilometers'
				});

				// éŠ€æ²³ã®ä½ç½®ã‚’è¨ˆç®—ï¼ˆè·é›¢å††ä¸Šã®å³å´ã€90åº¦ã®ä½ç½®ï¼‰
				const galaxyPosition = turf.destination(milkyWayCoordinates, mapDistanceKm, 90, { units: 'kilometers' });

				const distanceSourceId = `distance-source-${galaxy.name}`;
				const distanceLayerId = `distance-${galaxy.name}`;

				// è·é›¢å††ã®ã‚½ãƒ¼ã‚¹ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
				map.addSource(distanceSourceId, {
					type: 'geojson',
					data: distanceCircle
				});

				// è·é›¢å††ã®ç·šå¹…ã¨é€æ˜åº¦ã‚’ç¨®åˆ¥ã«ã‚ˆã£ã¦èª¿æ•´
				const lineWidth = galaxy.type === 'dwarf' ? 3 : (galaxy.type === 'cluster' ? 5 : 4);
				const lineOpacity = galaxy.distanceLY <= 10000000 ? 0.7 : 0.5;
				const lineDasharray = galaxy.type === 'cluster' ? [10, 10] : null;

				const layerPaint = {
					'line-color': galaxy.color,
					'line-width': lineWidth,
					'line-opacity': lineOpacity
				};
				if (lineDasharray) {
					layerPaint['line-dasharray'] = lineDasharray;
				}

				map.addLayer({
					id: distanceLayerId,
					type: 'line',
					source: distanceSourceId,
					paint: layerPaint
				});

				// è·é›¢å††ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
				map.on('click', distanceLayerId, (e) => {
					const coordinates = e.lngLat;
					const lightTime = calculateLightTravelTime(galaxy.distanceLY);
					const distanceTrillionKm = (actualDistanceKm / 1000000000000).toFixed(2);

					let popupContent = `
						<div style="font-family: 'Segoe UI', sans-serif; min-width: 250px;">
							<h3 style="margin: 0 0 10px 0; color: ${galaxy.color}; font-size: 16px;">
								${galaxy.name}
							</h3>
							<div style="font-size: 13px; line-height: 1.6;">
								<p style="margin: 5px 0;"><strong>è·é›¢:</strong> ${galaxy.distanceLY.toLocaleString('ja-JP')} å…‰å¹´</p>
								<p style="margin: 5px 0;"><strong>å®Ÿéš›ã®è·é›¢:</strong> ${distanceTrillionKm} å…†km</p>
								<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
								<p style="margin: 5px 0; font-weight: bold; color: #333;">ğŸš€ å…‰ã®åˆ°é”æ™‚é–“:</p>
								<p style="margin: 3px 0 3px 15px;">ğŸ’¡ å…‰é€Ÿ: <strong>${lightTime}</strong></p>
								<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
								<p style="margin: 5px 0;"><strong>ğŸ”­ ç¨®åˆ¥:</strong> ${TYPE_NAMES[galaxy.type]}</p>
					`;

					if (galaxy.discoveryYear) {
						popupContent += `<p style="margin: 5px 0;"><strong>ğŸ“… ç™ºè¦‹å¹´:</strong> ${galaxy.discoveryYear}å¹´</p>`;
					}

					popupContent += `
								<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
								<p style="margin: 5px 0;">
									<a href="https://www.google.com/maps?q=${coordinates.lat},${coordinates.lng}" 
									   target="_blank" 
									   style="color: #4CAF50; text-decoration: none;">
										ğŸ“ Google Mapsã§ã“ã®å ´æ‰€ã‚’è¦‹ã‚‹
									</a>
								</p>
							</div>
						</div>
					`;

					new maplibregl.Popup({
						maxWidth: '350px'
					})
						.setLngLat(coordinates)
						.setHTML(popupContent)
						.addTo(map);
				});

				// ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã«å¤‰æ›´
				map.on('mouseenter', distanceLayerId, () => {
					map.getCanvas().style.cursor = 'pointer';
				});

				map.on('mouseleave', distanceLayerId, () => {
					map.getCanvas().style.cursor = '';
				});

				// éŠ€æ²³æœ¬ä½“ã‚’æç”»ï¼ˆç›´å¾„ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
				if (galaxy.diameterLY > 0) {
					const actualGalaxyDiameterKm = galaxy.diameterLY * LIGHT_YEAR_IN_KM;
					const mapGalaxyDiameterKm = actualGalaxyDiameterKm * scale;
					const mapGalaxyRadiusKm = mapGalaxyDiameterKm / 2;

					// éŠ€æ²³ã®å††ã‚’ç”Ÿæˆ
					const galaxyCircle = turf.circle(galaxyPosition.geometry.coordinates, mapGalaxyRadiusKm, {
						steps: 64,
						units: 'kilometers'
					});

					const galaxySourceId = `galaxy-source-${galaxy.name}`;
					const galaxyLayerId = `galaxy-${galaxy.name}`;

					map.addSource(galaxySourceId, {
						type: 'geojson',
						data: galaxyCircle
					});

					map.addLayer({
						id: galaxyLayerId,
						type: 'fill',
						source: galaxySourceId,
						paint: {
							'fill-color': galaxy.color,
							'fill-opacity': 0.6
						}
					});

					// éŠ€æ²³æœ¬ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
					map.on('click', galaxyLayerId, (e) => {
						const coordinates = e.lngLat;
						const lightTime = calculateLightTravelTime(galaxy.distanceLY);
						const distanceTrillionKm = (actualDistanceKm / 1000000000000).toFixed(2);

						let popupContent = `
							<div style="font-family: 'Segoe UI', sans-serif; min-width: 250px;">
								<h3 style="margin: 0 0 10px 0; color: ${galaxy.color}; font-size: 16px;">
									${galaxy.name}
								</h3>
								<div style="font-size: 13px; line-height: 1.6;">
									<p style="margin: 5px 0;"><strong>ç›´å¾„:</strong> ${galaxy.diameterLY.toLocaleString('ja-JP')} å…‰å¹´</p>
									<p style="margin: 5px 0;"><strong>è·é›¢:</strong> ${galaxy.distanceLY.toLocaleString('ja-JP')} å…‰å¹´</p>
									<p style="margin: 5px 0;"><strong>éŠ€æ²³ç³»ã‹ã‚‰ã®è·é›¢:</strong> ${distanceTrillionKm} å…†km</p>
									<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
									<p style="margin: 5px 0; font-weight: bold; color: #333;">ğŸš€ éŠ€æ²³ç³»ã‹ã‚‰ã®å…‰ã®åˆ°é”æ™‚é–“:</p>
									<p style="margin: 3px 0 3px 15px;">ğŸ’¡ å…‰é€Ÿ: <strong>${lightTime}</strong></p>
									<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
									<p style="margin: 5px 0;"><strong>ğŸ”­ ç¨®åˆ¥:</strong> ${TYPE_NAMES[galaxy.type]}</p>
						`;

						if (galaxy.discoveryYear) {
							popupContent += `<p style="margin: 5px 0;"><strong>ğŸ“… ç™ºè¦‹å¹´:</strong> ${galaxy.discoveryYear}å¹´</p>`;
						}

						popupContent += `
									<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
									<p style="margin: 5px 0;">
										<a href="https://www.google.com/maps?q=${coordinates.lat},${coordinates.lng}" 
										   target="_blank" 
										   style="color: #4CAF50; text-decoration: none;">
											ğŸ“ Google Mapsã§ã“ã®å ´æ‰€ã‚’è¦‹ã‚‹
										</a>
									</p>
								</div>
							</div>
						`;

						new maplibregl.Popup({
							maxWidth: '350px'
						})
							.setLngLat(coordinates)
							.setHTML(popupContent)
							.addTo(map);
					});

					// ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã«å¤‰æ›´
					map.on('mouseenter', galaxyLayerId, () => {
						map.getCanvas().style.cursor = 'pointer';
					});

					map.on('mouseleave', galaxyLayerId, () => {
						map.getCanvas().style.cursor = '';
					});
				}

				// éŠ€æ²³ãƒ©ãƒ™ãƒ«ã®è¿½åŠ 
				const labelSourceId = `label-source-${galaxy.name}`;
				const labelLayerId = `label-${galaxy.name}`;

				// ãƒ©ãƒ™ãƒ«ç”¨ã®ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆ
				const labelPoint = turf.point(galaxyPosition.geometry.coordinates, {
					name: galaxy.name
				});

				map.addSource(labelSourceId, {
					type: 'geojson',
					data: labelPoint
				});

				// ãƒ©ãƒ™ãƒ«ã‚µã‚¤ã‚ºã‚’ç¨®åˆ¥ã«ã‚ˆã£ã¦èª¿æ•´
				const textSize = galaxy.type === 'dwarf' ? 16 : (galaxy.type === 'cluster' ? 20 : 18);

				map.addLayer({
					id: labelLayerId,
					type: 'symbol',
					source: labelSourceId,
					layout: {
						'text-field': ['get', 'name'],
						'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
						'text-size': textSize,
						'text-offset': [0, -2.5],
						'text-anchor': 'bottom'
					},
					paint: {
						'text-color': galaxy.color,
						'text-halo-color': '#ffffff',
						'text-halo-width': 3
					}
				});

				console.log(`${galaxy.name}: è·é›¢ ${mapDistanceKm.toFixed(2)} km`);
			});

			// ç¯„å›²å¤–ã®éŠ€æ²³ãƒªã‚¹ãƒˆã‚’æ›´æ–°
			updateOutOfRangeList();
		}

		// ========== æç”»ç¯„å›²å¤–ã®éŠ€æ²³ãƒªã‚¹ãƒˆã‚’æ›´æ–° ==========
		function updateOutOfRangeList() {
			const listElement = document.getElementById('outOfRangeList');

			if (!window.outOfRangeGalaxies || window.outOfRangeGalaxies.length === 0) {
				listElement.innerHTML = '<div class="out-of-range-empty">ã™ã¹ã¦ã®éŠ€æ²³ãŒè¡¨ç¤ºç¯„å›²å†…ã§ã™</div>';
				return;
			}

			let html = '';
			window.outOfRangeGalaxies.forEach(galaxy => {
				html += `<div class="out-of-range-item" style="border-left-color: ${galaxy.color};">`;
				html += `<strong>${galaxy.name}</strong><br>`;
				html += `è·é›¢: ${galaxy.distanceKm.toLocaleString('ja-JP', { maximumFractionDigits: 0 })} km<br>`;
				html += `åœ°çƒ <strong>${galaxy.timesAroundEarth.toFixed(1)}</strong> å‘¨åˆ†`;
				html += `</div>`;
			});

			listElement.innerHTML = html;
		}

		// ========== åœ°å›³ã‚¹ã‚¿ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆ ==========
		function changeMapStyle() {
			const selectedStyle = document.getElementById('mapStyle').value;

			// ç¾åœ¨ã®ä¸­å¿ƒåº§æ¨™ã¨ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’ä¿å­˜
			const currentCenter = map.getCenter();
			const currentZoom = map.getZoom();
			const currentMilkyWayCoords = milkyWayCoordinates;

			// åœ°å›³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
			map.setStyle(MAP_STYLES[selectedStyle]);

			// ã‚¹ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«éŠ€æ²³ã‚’å†æç”»
			map.once('styledata', () => {
				// ä¸­å¿ƒåº§æ¨™ã¨ã‚ºãƒ¼ãƒ ã‚’å¾©å…ƒ
				map.setCenter(currentCenter);
				map.setZoom(currentZoom);

				// éŠ€æ²³ç³»ã®ä½ç½®ã‚’å¾©å…ƒ
				milkyWayCoordinates = currentMilkyWayCoords;
				if (milkyWayMarker) {
					milkyWayMarker.setLngLat(milkyWayCoordinates);
				}

				// éŠ€æ²³ã‚’å†æç”»
				updateGalaxies();
			});
		}

		// ========== å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ ==========
		function toggleFullscreen() {
			if (!document.fullscreenElement) {
				// å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
				document.documentElement.requestFullscreen().catch(err => {
					alert(`å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã§ãã¾ã›ã‚“ã§ã—ãŸ: ${err.message}`);
				});
			} else {
				// å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
				if (document.exitFullscreen) {
					document.exitFullscreen();
				}
			}
		}

		// å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã®å¤‰åŒ–ã‚’ç›£è¦–ã—ã¦ãƒœã‚¿ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
		document.addEventListener('fullscreenchange', () => {
			const btn = document.querySelector('.fullscreen-btn');
			if (document.fullscreenElement) {
				btn.textContent = 'âŒ'; // å…¨ç”»é¢ä¸­ã¯çµ‚äº†ã‚¢ã‚¤ã‚³ãƒ³
				btn.title = 'å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†';
			} else {
				btn.textContent = 'â›¶'; // é€šå¸¸æ™‚ã¯å…¨ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³
				btn.title = 'å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰';
			}
		});

		// ========== ç¾åœ¨åœ°ã‚’ä¸­å¿ƒã«ã™ã‚‹ ==========
		function setCurrentLocation() {
			const locationBtn = document.querySelector('.location-btn');

			if (!navigator.geolocation) {
				alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±æ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
				return;
			}

			// ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
			locationBtn.disabled = true;
			locationBtn.textContent = 'ğŸ“¡';

			navigator.geolocation.getCurrentPosition(
				// æˆåŠŸæ™‚
				(position) => {
					const { latitude, longitude } = position.coords;

					// ä¸­å¿ƒä½ç½®ã‚’ç¾åœ¨åœ°ã«æ›´æ–°
					milkyWayCoordinates = [longitude, latitude];

					// ãƒãƒ¼ã‚«ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°
					if (milkyWayMarker) {
						milkyWayMarker.setLngLat(milkyWayCoordinates);
					}

					// åœ°å›³ã®ä¸­å¿ƒã‚’ç¾åœ¨åœ°ã«ç§»å‹•
					map.flyTo({
						center: milkyWayCoordinates,
						zoom: 14,
						duration: 2000
					});

					// æç”»ã‚’æ›´æ–°
					updateGalaxies();

					// ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
					locationBtn.disabled = false;
					locationBtn.textContent = 'ğŸ“';
				},
				// ã‚¨ãƒ©ãƒ¼æ™‚
				(error) => {
					let errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';

					switch (error.code) {
						case error.PERMISSION_DENIED:
							errorMessage = 'ä½ç½®æƒ…å ±ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
							break;
						case error.POSITION_UNAVAILABLE:
							errorMessage = 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
							break;
						case error.TIMEOUT:
							errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚';
							break;
					}

					alert(errorMessage);

					// ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
					locationBtn.disabled = false;
					locationBtn.textContent = 'ğŸ“';
				},
				// ã‚ªãƒ—ã‚·ãƒ§ãƒ³
				{
					enableHighAccuracy: true,
					timeout: 10000,
					maximumAge: 0
				}
			);
		}

		// ========== ãƒ‘ãƒãƒ«ã®æŠ˜ã‚ŠãŸãŸã¿ ==========
		function togglePanel(contentId) {
			const content = document.getElementById(contentId);
			const button = event.target;

			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				content.style.maxHeight = content.scrollHeight + 'px';
				button.textContent = 'â–¼';
			} else {
				content.style.maxHeight = content.scrollHeight + 'px';
				setTimeout(() => {
					content.classList.add('collapsed');
				}, 10);
				button.textContent = 'â–¶';
			}
		}

		// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å„ãƒ‘ãƒãƒ«ã®åˆæœŸmaxHeightã‚’è¨­å®š
		window.addEventListener('load', () => {
			init();

			// å„ãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆæœŸmaxHeightã‚’è¨­å®š
			['controlContent', 'outOfRangeContent', 'legendContent'].forEach(id => {
				const element = document.getElementById(id);
				if (element) {
					element.style.maxHeight = element.scrollHeight + 'px';
				}
			});
		});
	</script>
</body>

</html>