<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>å¤ªé™½ç³»å¤§ãã•ä½“æ„Ÿãƒãƒƒãƒ—</title>
	<meta name="description" content="ã€Œå¤ªé™½ç³»å¤§ãã•ä½“æ„Ÿãƒãƒƒãƒ—ã€ã¯å¤ªé™½ç³»ã®æƒ‘æ˜Ÿã‚„ãã®ä»–å¤©ä½“ã®å¤§ãã•ã‚’ç¸®å°ºã—ã¦åœ°å›³ä¸Šã«è¡¨ç¤ºã—ã¾ã™ã€‚å„å¤©ä½“ã®ç›¸å¯¾çš„ãªã‚µã‚¤ã‚ºã‚„è·é›¢æ„Ÿã‚’è¦–è¦šçš„ã«ç†è§£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚">
	<meta property="og:title" content="å¤ªé™½ç³»å¤§ãã•ä½“æ„Ÿãƒãƒƒãƒ—">
	<meta property="og:description" content="ã€Œå¤ªé™½ç³»å¤§ãã•ä½“æ„Ÿãƒãƒƒãƒ—ã€ã¯å¤ªé™½ç³»ã®æƒ‘æ˜Ÿã‚„ãã®ä»–å¤©ä½“ã®å¤§ãã•ã‚’ç¸®å°ºã—ã¦åœ°å›³ä¸Šã«è¡¨ç¤ºã—ã¾ã™ã€‚å„å¤©ä½“ã®ç›¸å¯¾çš„ãªã‚µã‚¤ã‚ºã‚„è·é›¢æ„Ÿã‚’è¦–è¦šçš„ã«ç†è§£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚">

	<!-- Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-89GN3KL35R"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());
		gtag('config', 'G-89GN3KL35R');
	</script>

	<!-- MapLibre GL JS -->
	<script src="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.js"></script>
	<link href="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.css" rel="stylesheet" />

	<!-- Turf.js -->
	<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

	<!-- PMTiles -->
	<script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>

	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		}

		#map {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 100%;
		}

		.control-panel {
			position: absolute;
			top: 20px;
			left: 20px;
			background: white;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			z-index: 1000;
			min-width: 300px;
		}

		.control-panel h2 {
			margin-bottom: 15px;
			font-size: 18px;
			color: #333;
		}

		.input-group {
			margin-bottom: 15px;
		}

		.input-group label {
			display: block;
			margin-bottom: 5px;
			font-size: 14px;
			color: #555;
		}

		.input-group input {
			width: 100%;
			padding: 8px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 14px;
		}

		.input-group input:focus {
			outline: none;
			border-color: #4CAF50;
		}

		.update-btn {
			width: 100%;
			padding: 10px;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 4px;
			font-size: 16px;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		.update-btn:hover {
			background-color: #45a049;
		}

		.map-selector {
			margin-bottom: 15px;
		}

		.map-selector label {
			display: block;
			margin-bottom: 5px;
			font-size: 14px;
			color: #555;
		}

		.map-selector select {
			width: 100%;
			padding: 8px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 14px;
			background-color: white;
			cursor: pointer;
		}

		.map-selector select:focus {
			outline: none;
			border-color: #4CAF50;
		}

		.legend {
			position: absolute;
			bottom: 30px;
			right: 20px;
			background: white;
			padding: 15px;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			z-index: 1000;
		}

		.legend h3 {
			margin-bottom: 10px;
			font-size: 14px;
			color: #333;
		}

		.legend-item {
			display: flex;
			align-items: center;
			margin-bottom: 5px;
			font-size: 12px;
		}

		.legend-color {
			width: 20px;
			height: 3px;
			margin-right: 8px;
			border-radius: 2px;
		}

		.info-text {
			font-size: 12px;
			color: #666;
			margin-top: 10px;
		}

		.out-of-range {
			position: absolute;
			top: 20px;
			right: 20px;
			background: white;
			padding: 15px;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			z-index: 1000;
			max-width: 300px;
		}

		.out-of-range h3 {
			margin-bottom: 10px;
			font-size: 14px;
			color: #333;
		}

		.out-of-range-item {
			font-size: 12px;
			color: #666;
			margin-bottom: 5px;
			padding: 5px;
			border-left: 3px solid;
			padding-left: 8px;
		}

		.out-of-range-empty {
			font-size: 12px;
			color: #999;
			font-style: italic;
		}

		.panel-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}

		.panel-header h2,
		.panel-header h3 {
			margin-bottom: 0;
		}

		.toggle-btn {
			background: none;
			border: none;
			font-size: 18px;
			cursor: pointer;
			padding: 5px;
			color: #666;
			transition: color 0.3s;
		}

		.toggle-btn:hover {
			color: #333;
		}

		.panel-content {
			transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
			overflow: hidden;
		}

		.panel-content.collapsed {
			max-height: 0 !important;
			opacity: 0;
			margin: 0;
			padding: 0;
		}

		.fullscreen-btn,
		.location-btn {
			position: absolute;
			left: 20px;
			background: white;
			border: none;
			border-radius: 4px;
			padding: 10px 15px;
			font-size: 20px;
			cursor: pointer;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			z-index: 1000;
			transition: background-color 0.3s;
			width: 50px;
			height: 50px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.fullscreen-btn {
			bottom: 30px;
		}

		.location-btn {
			bottom: 90px;
		}

		.fullscreen-btn:hover,
		.location-btn:hover {
			background-color: #f0f0f0;
		}

		.location-btn:hover {
			background-color: #f0f0f0;
		}

		.location-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
	</style>
</head>

<body>
	<div id="map"></div>

	<a href="index.html" class="home-link" title="ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹">ğŸ  ãƒ›ãƒ¼ãƒ </a>

	<button class="fullscreen-btn" onclick="toggleFullscreen()" title="å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰">â›¶</button>
	<button class="location-btn" onclick="setCurrentLocation()" title="ç¾åœ¨åœ°ã‚’å¤ªé™½ã®ä¸­å¿ƒã«ã™ã‚‹">ğŸ“</button>

	<div class="control-panel">
		<div class="panel-header">
			<h2>ğŸŒ å¤ªé™½ç³»å¤§ãã•ä½“æ„Ÿãƒãƒƒãƒ—</h2>
			<button class="toggle-btn" onclick="togglePanel('controlContent')" title="ãƒ‘ãƒãƒ«ã‚’æŠ˜ã‚ŠãŸãŸã‚€">â–¼</button>
		</div>

		<div id="controlContent" class="panel-content">
			<div class="map-selector">
				<label for="mapStyle">èƒŒæ™¯åœ°å›³:</label>
				<select id="mapStyle" onchange="changeMapStyle()">
					<option value="osm">OpenStreetMap</option>
					<option value="gsi-std">åœ°ç†é™¢åœ°å›³(æ¨™æº–)</option>
					<option value="gsi-pale">åœ°ç†é™¢åœ°å›³(æ·¡è‰²)</option>
					<option value="gsi-blank">åœ°ç†é™¢åœ°å›³(ç™½åœ°å›³)</option>
					<option value="gsi-photo">åœ°ç†é™¢åœ°å›³(è¡›æ˜Ÿå†™çœŸ)</option>
					<option value="gsi-vector">åœ°ç†é™¢åœ°å›³(ãƒ™ã‚¯ãƒˆãƒ«ã‚¿ã‚¤ãƒ«)</option>
				</select>
			</div>

			<div class="input-group">
				<label for="earthDiameter">åœ°çƒã®ç›´å¾„ (cm):</label>
				<input type="number" id="earthDiameter" value="1.3" step="0.1" min="0.1">
			</div>

			<div class="input-group">
				<label for="sunDiameter">å¤ªé™½ã®ç›´å¾„ (m):</label>
				<input type="number" id="sunDiameter" step="0.1" min="0.1">
			</div>

			<button class="update-btn" onclick="updateOrbits()">æç”»æ›´æ–°</button>

			<div class="info-text">
				â„¹ï¸ å¤ªé™½ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä½ç½®ã‚’å¤‰æ›´ã§ãã¾ã™
			</div>
		</div>
	</div>

	<div class="out-of-range" id="outOfRange">
		<div class="panel-header">
			<h3>ğŸ“ æç”»ç¯„å›²å¤–ã®å¤©ä½“</h3>
			<button class="toggle-btn" onclick="togglePanel('outOfRangeContent')" title="ãƒ‘ãƒãƒ«ã‚’æŠ˜ã‚ŠãŸãŸã‚€">â–¼</button>
		</div>
		<div id="outOfRangeContent" class="panel-content">
			<div id="outOfRangeList">
				<div class="out-of-range-empty">æƒ…å ±ãªã—</div>
			</div>
		</div>
	</div>

	<div class="legend">
		<div class="panel-header">
			<h3>å¤©ä½“ãƒ»é ˜åŸŸ</h3>
			<button class="toggle-btn" onclick="togglePanel('legendContent')" title="ãƒ‘ãƒãƒ«ã‚’æŠ˜ã‚ŠãŸãŸã‚€">â–¼</button>
		</div>
		<div id="legendContent" class="panel-content">
			<div class="legend-item">
				<div class="legend-color" style="background-color: #A0A0A0;"></div>
				<span>æ°´æ˜Ÿ (0.39 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #FFA500;"></div>
				<span>é‡‘æ˜Ÿ (0.72 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #4169E1;"></div>
				<span>åœ°çƒ (1.00 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #DC143C;"></div>
				<span>ç«æ˜Ÿ (1.52 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #DAA520;"></div>
				<span>æœ¨æ˜Ÿ (5.20 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #F4A460;"></div>
				<span>åœŸæ˜Ÿ (9.58 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #00CED1;"></div>
				<span>ãƒãƒ¬ãƒ¼å½—æ˜Ÿ (17.8 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #40E0D0;"></div>
				<span>å¤©ç‹æ˜Ÿ (19.22 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #1E90FF;"></div>
				<span>æµ·ç‹æ˜Ÿ (30.05 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #8B7355;"></div>
				<span>å†¥ç‹æ˜Ÿ (39.48 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #696969;"></div>
				<span>ã‚«ã‚¤ãƒ‘ãƒ¼ãƒ™ãƒ«ãƒˆ (50 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #2F4F4F;"></div>
				<span>ã‚ªãƒ¼ãƒ«ãƒˆã®é›²å†…ç¸ (2,000 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #1C1C1C;"></div>
				<span>ã‚ªãƒ¼ãƒ«ãƒˆã®é›²å¤–ç¸ (100,000 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #FF6347;"></div>
				<span>ãƒ—ãƒ­ã‚­ã‚·ãƒãƒ»ã‚±ãƒ³ã‚¿ã‚¦ãƒª (268,770 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #87CEEB;"></div>
				<span>ã‚·ãƒªã‚¦ã‚¹ (542,520 AU)</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #E0FFFF;"></div>
				<span>ãƒ™ã‚¬ (1,625,000 AU)</span>
			</div>
		</div>
	</div>

	<script>
		// ========== å®šæ•°å®šç¾© ==========
		// åœ°çƒã®å®Ÿéš›ã®ç›´å¾„ï¼ˆkmï¼‰
		const EARTH_ACTUAL_DIAMETER_KM = 12742;

		// å¤ªé™½ã®å®Ÿéš›ã®ç›´å¾„ï¼ˆkmï¼‰
		const SUN_ACTUAL_DIAMETER_KM = 1392700;

		// 1å¤©æ–‡å˜ä½ï¼ˆkmï¼‰
		const AU_IN_KM = 149600000;

		// æƒ‘æ˜Ÿãƒ‡ãƒ¼ã‚¿: åå‰ã€è»Œé“åŠå¾„ï¼ˆAUï¼‰ã€å®Ÿéš›ã®ç›´å¾„ï¼ˆkmï¼‰ã€è‰²ã€ç¨®åˆ¥
		const PLANETS = [
			{ name: 'æ°´æ˜Ÿ', orbitAU: 0.387, diameterKm: 4879, color: '#A0A0A0', type: 'planet', eccentricity: 0.205, perihelionAU: 0.307, perihelionAngleDeg: 29.1, orbitAngleDeg: 0 },
			{ name: 'é‡‘æ˜Ÿ', orbitAU: 0.723, diameterKm: 12104, color: '#FFA500', type: 'planet', eccentricity: 0.007, perihelionAU: 0.718, perihelionAngleDeg: 55.2, orbitAngleDeg: 45 },
			{ name: 'åœ°çƒ', orbitAU: 1.00, diameterKm: 12742, color: '#4169E1', type: 'planet', eccentricity: 0.017, perihelionAU: 0.983, perihelionAngleDeg: 102.9, orbitAngleDeg: 90 },
			{ name: 'ç«æ˜Ÿ', orbitAU: 1.524, diameterKm: 6779, color: '#DC143C', type: 'planet', eccentricity: 0.093, perihelionAU: 1.381, perihelionAngleDeg: 286.5, orbitAngleDeg: 135 },
			{ name: 'æœ¨æ˜Ÿ', orbitAU: 5.203, diameterKm: 139820, color: '#DAA520', type: 'planet', eccentricity: 0.048, perihelionAU: 4.953, perihelionAngleDeg: 14.8, orbitAngleDeg: 180 },
			{ name: 'åœŸæ˜Ÿ', orbitAU: 9.537, diameterKm: 116460, color: '#F4A460', type: 'planet', eccentricity: 0.054, perihelionAU: 9.022, perihelionAngleDeg: 92.4, orbitAngleDeg: 225 },
			{ name: 'ãƒãƒ¬ãƒ¼å½—æ˜Ÿ', orbitAU: 17.8, diameterKm: 15, color: '#00CED1', type: 'comet', eccentricity: 0.967, perihelionAU: 0.586, perihelionAngleDeg: 111.3, orbitAngleDeg: 111.3 },
			{ name: 'å¤©ç‹æ˜Ÿ', orbitAU: 19.191, diameterKm: 50724, color: '#40E0D0', type: 'planet', eccentricity: 0.047, perihelionAU: 18.286, perihelionAngleDeg: 170.9, orbitAngleDeg: 270 },
			{ name: 'æµ·ç‹æ˜Ÿ', orbitAU: 30.069, diameterKm: 49244, color: '#1E90FF', type: 'planet', eccentricity: 0.009, perihelionAU: 29.798, perihelionAngleDeg: 44.9, orbitAngleDeg: 315 },
			{ name: 'å†¥ç‹æ˜Ÿ', orbitAU: 39.482, diameterKm: 2376, color: '#8B7355', type: 'dwarf', eccentricity: 0.249, perihelionAU: 29.658, perihelionAngleDeg: 113.8, orbitAngleDeg: 30 },
			{ name: 'ã‚«ã‚¤ãƒ‘ãƒ¼ãƒ™ãƒ«ãƒˆ', orbitAU: 50, diameterKm: 0, color: '#696969', type: 'region', orbitAngleDeg: 60 },
			{ name: 'ã‚ªãƒ¼ãƒ«ãƒˆã®é›²(å†…ç¸)', orbitAU: 2000, diameterKm: 0, color: '#2F4F4F', type: 'region', orbitAngleDeg: 120 },
			{ name: 'ãƒ—ãƒ­ã‚­ã‚·ãƒãƒ»ã‚±ãƒ³ã‚¿ã‚¦ãƒª', orbitAU: 268770, diameterKm: 0, color: '#FF6347', type: 'star', orbitAngleDeg: 150 },
			{ name: 'ã‚·ãƒªã‚¦ã‚¹', orbitAU: 542520, diameterKm: 0, color: '#87CEEB', type: 'star', orbitAngleDeg: 200 },
			{ name: 'ãƒ™ã‚¬', orbitAU: 1584000, diameterKm: 0, color: '#E0FFFF', type: 'star', orbitAngleDeg: 250 }
		];

		// åˆæœŸä¸­å¿ƒåº§æ¨™: ã¿ã•ã¨å¤©æ–‡å°
		const INITIAL_CENTER = [135.40660, 34.14466]; // [çµŒåº¦, ç·¯åº¦]

		// ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ==========
		let map;
		let sunMarker;
		let sunCoordinates = INITIAL_CENTER;

		// åœ°å›³ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
		const MAP_STYLES = {
			'osm': {
				version: 8,
				glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
				sources: {
					'osm': {
						type: 'raster',
						tiles: [
							'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
							'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
							'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
						],
						tileSize: 256,
						attribution: 'Â© OpenStreetMap contributors'
					}
				},
				layers: [{
					id: 'osm',
					type: 'raster',
					source: 'osm',
					minzoom: 0,
					maxzoom: 19
				}]
			},
			'gsi-std': {
				version: 8,
				glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
				sources: {
					'gsi-std': {
						type: 'raster',
						tiles: [
							'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'
						],
						tileSize: 256,
						attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>'
					}
				},
				layers: [{
					id: 'gsi-std',
					type: 'raster',
					source: 'gsi-std',
					minzoom: 0,
					maxzoom: 18
				}]
			},
			'gsi-pale': {
				version: 8,
				glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
				sources: {
					'gsi-pale': {
						type: 'raster',
						tiles: [
							'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png'
						],
						tileSize: 256,
						attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>'
					}
				},
				layers: [{
					id: 'gsi-pale',
					type: 'raster',
					source: 'gsi-pale',
					minzoom: 0,
					maxzoom: 18
				}]
			},
			'gsi-blank': {
				version: 8,
				glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
				sources: {
					'gsi-blank': {
						type: 'raster',
						tiles: [
							'https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png'
						],
						tileSize: 256,
						attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>'
					}
				},
				layers: [{
					id: 'gsi-blank-layer',
					type: 'raster',
					source: 'gsi-blank',
					minzoom: 0,
					maxzoom: 14
				}]
			},
			'gsi-photo': {
				version: 8,
				glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
				sources: {
					'gsi-photo': {
						type: 'raster',
						tiles: [
							'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'
						],
						tileSize: 256,
						attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>'
					}
				},
				layers: [{
					id: 'gsi-photo',
					type: 'raster',
					source: 'gsi-photo',
					minzoom: 0,
					maxzoom: 18
				}]
			},
			'gsi-vector': 'https://gsi-cyberjapan.github.io/optimal_bvmap/style/std.json'
		};

		// ========== åˆ°é”æ™‚é–“ã®è¨ˆç®— ==========
		function calculateTravelTime(distanceKm) {
			const LIGHT_SPEED_KM_S = 299792.458; // å…‰é€Ÿ km/s
			const SHINKANSEN_KM_H = 300; // æ–°å¹¹ç·š km/h
			const WALKING_KM_H = 4; // å¾’æ­© km/h

			// å…‰é€Ÿã§ã®æ™‚é–“
			const lightSeconds = distanceKm / LIGHT_SPEED_KM_S;
			let lightTime = '';
			if (lightSeconds < 60) {
				lightTime = `${lightSeconds.toFixed(2)}ç§’`;
			} else if (lightSeconds < 3600) {
				lightTime = `${(lightSeconds / 60).toFixed(2)}åˆ†`;
			} else if (lightSeconds < 86400) {
				lightTime = `${(lightSeconds / 3600).toFixed(2)}æ™‚é–“`;
			} else if (lightSeconds < 31536000) {
				lightTime = `${(lightSeconds / 86400).toFixed(2)}æ—¥`;
			} else {
				lightTime = `${(lightSeconds / 31536000).toFixed(2)}å¹´`;
			}

			// æ–°å¹¹ç·šã§ã®æ™‚é–“
			const shinkansenHours = distanceKm / SHINKANSEN_KM_H;
			let shinkansenTime = '';
			if (shinkansenHours < 24) {
				shinkansenTime = `${shinkansenHours.toFixed(1)}æ™‚é–“`;
			} else if (shinkansenHours < 8760) {
				shinkansenTime = `${(shinkansenHours / 24).toFixed(1)}æ—¥`;
			} else {
				shinkansenTime = `${(shinkansenHours / 8760).toFixed(1)}å¹´`;
			}

			// å¾’æ­©ã§ã®æ™‚é–“
			const walkingHours = distanceKm / WALKING_KM_H;
			let walkingTime = '';
			if (walkingHours < 24) {
				walkingTime = `${walkingHours.toFixed(1)}æ™‚é–“`;
			} else if (walkingHours < 8760) {
				walkingTime = `${(walkingHours / 24).toFixed(1)}æ—¥`;
			} else {
				walkingTime = `${(walkingHours / 8760).toFixed(1)}å¹´`;
			}

			return {
				light: lightTime,
				shinkansen: shinkansenTime,
				walking: walkingTime
			};
		}

		// ========== åˆæœŸåŒ– ==========
		function init() {
			// PMTilesãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ç™»éŒ²
			const protocol = new pmtiles.Protocol();
			maplibregl.addProtocol('pmtiles', protocol.tile);

			// åœ°å›³ã®åˆæœŸåŒ–
			map = new maplibregl.Map({
				container: 'map',
				style: MAP_STYLES['osm'],
				center: INITIAL_CENTER,
				zoom: 14
			});			// åœ°å›³ã®èª­ã¿è¾¼ã¿å®Œäº†å¾Œ
			map.on('load', () => {
				// å¤ªé™½ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆ
				createSunMarker();

				// åˆæœŸå€¤ã§å¤ªé™½ã®ç›´å¾„ã‚’è¨ˆç®—
				updateSunDiameter();

				// åˆæœŸæç”»
				updateOrbits();
			});

			// åœ°çƒã®ç›´å¾„å…¥åŠ›æ™‚ã«å¤ªé™½ã®ç›´å¾„ã‚’è‡ªå‹•è¨ˆç®—
			document.getElementById('earthDiameter').addEventListener('input', updateSunDiameter);

			// å¤ªé™½ã®ç›´å¾„å…¥åŠ›æ™‚ã«åœ°çƒã®ç›´å¾„ã‚’è‡ªå‹•è¨ˆç®—
			document.getElementById('sunDiameter').addEventListener('input', updateEarthDiameter);

			// Enterã‚­ãƒ¼ã§æç”»æ›´æ–°
			document.getElementById('earthDiameter').addEventListener('keypress', (e) => {
				if (e.key === 'Enter') updateOrbits();
			});
			document.getElementById('sunDiameter').addEventListener('keypress', (e) => {
				if (e.key === 'Enter') updateOrbits();
			});
		}

		// ========== å¤ªé™½ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆ ==========
		function createSunMarker() {
			// ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼è¦ç´ ã®ä½œæˆ
			const el = document.createElement('div');
			el.style.width = '30px';
			el.style.height = '30px';
			el.style.borderRadius = '50%';
			el.style.background = 'radial-gradient(circle, #FFD700, #FFA500)';
			el.style.border = '3px solid white';
			el.style.boxShadow = '0 0 15px rgba(255, 165, 0, 0.7)';
			el.style.cursor = 'move';

			// ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆ
			sunMarker = new maplibregl.Marker({
				element: el,
				draggable: true
			})
				.setLngLat(sunCoordinates)
				.addTo(map);

			// ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
			sunMarker.on('dragend', () => {
				sunCoordinates = sunMarker.getLngLat().toArray();
				updateOrbits();
			});
		}

		// ========== åœ°çƒã®ç›´å¾„ã‹ã‚‰å¤ªé™½ã®ç›´å¾„ã‚’è¨ˆç®— ==========
		function updateSunDiameter() {
			const earthDiameterCm = parseFloat(document.getElementById('earthDiameter').value);
			if (isNaN(earthDiameterCm) || earthDiameterCm <= 0) return;

			// ç¸®å°ºä¿‚æ•°ã®è¨ˆç®—
			// Scale = å…¥åŠ›ã•ã‚ŒãŸåœ°çƒã®ç›´å¾„(cm) / (åœ°çƒã®å®Ÿéš›ã®ç›´å¾„(km) * 100,000)
			const scale = earthDiameterCm / (EARTH_ACTUAL_DIAMETER_KM * 100000);

			// å¤ªé™½ã®ç¸®å°ºå¾Œã®ç›´å¾„ï¼ˆcmï¼‰
			const sunDiameterCm = SUN_ACTUAL_DIAMETER_KM * 100000 * scale;

			// ãƒ¡ãƒ¼ãƒˆãƒ«ã«å¤‰æ›
			const sunDiameterM = sunDiameterCm / 100;

			// å¤ªé™½ã®ç›´å¾„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
			document.getElementById('sunDiameter').value = sunDiameterM.toFixed(2);
		}

		// ========== å¤ªé™½ã®ç›´å¾„ã‹ã‚‰åœ°çƒã®ç›´å¾„ã‚’è¨ˆç®— ==========
		function updateEarthDiameter() {
			const sunDiameterM = parseFloat(document.getElementById('sunDiameter').value);
			if (isNaN(sunDiameterM) || sunDiameterM <= 0) return;

			// å¤ªé™½ã®ç›´å¾„ã‚’cmã«å¤‰æ›
			const sunDiameterCm = sunDiameterM * 100;

			// ç¸®å°ºä¿‚æ•°ã®è¨ˆç®—
			const scale = sunDiameterCm / (SUN_ACTUAL_DIAMETER_KM * 100000);

			// åœ°çƒã®ç¸®å°ºå¾Œã®ç›´å¾„ï¼ˆcmï¼‰
			const earthDiameterCm = EARTH_ACTUAL_DIAMETER_KM * 100000 * scale;

			// åœ°çƒã®ç›´å¾„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
			document.getElementById('earthDiameter').value = earthDiameterCm.toFixed(2);
		}

		// ========== è»Œé“ã®æ›´æ–°ãƒ»æç”» ==========
		function updateOrbits() {
			const earthDiameterCm = parseFloat(document.getElementById('earthDiameter').value);

			if (isNaN(earthDiameterCm) || earthDiameterCm <= 0) {
				alert('æœ‰åŠ¹ãªåœ°çƒã®ç›´å¾„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
				return;
			}

			// ç¸®å°ºä¿‚æ•°ã®è¨ˆç®—
			// Scale = å…¥åŠ›ã•ã‚ŒãŸåœ°çƒã®ç›´å¾„(cm) / (åœ°çƒã®å®Ÿéš›ã®ç›´å¾„(km) * 100,000)
			const scale = earthDiameterCm / (EARTH_ACTUAL_DIAMETER_KM * 100000);

			// 1AU ãŒåœ°å›³ä¸Šã§ä½•ãƒ¡ãƒ¼ãƒˆãƒ«ã«ãªã‚‹ã‹ã‚’è¨ˆç®—
			// 1AU (km) â†’ cm ã«å¤‰æ›ã—ã¦ç¸®å°ºä¿‚æ•°ã‚’æ›ã‘ã€ãƒ¡ãƒ¼ãƒˆãƒ«ã«æˆ»ã™
			const oneAUInMeters = (AU_IN_KM * 100000 * scale) / 100;

			console.log(`ç¸®å°º: åœ°çƒ ${earthDiameterCm} cm`);
			console.log(`1AU = ${oneAUInMeters.toFixed(2)} m`);

			// ç¯„å›²å¤–ã®å¤©ä½“ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
			window.outOfRangePlanets = [];

			// æ—¢å­˜ã®è»Œé“ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤
			PLANETS.forEach(planet => {
				const orbitLayerId = `orbit-${planet.name}`;
				const orbitSourceId = `orbit-source-${planet.name}`;
				const planetLayerId = `planet-${planet.name}`;
				const planetSourceId = `planet-source-${planet.name}`;
				const labelLayerId = `label-${planet.name}`;
				const labelSourceId = `label-source-${planet.name}`;

				if (map.getLayer(orbitLayerId)) {
					map.removeLayer(orbitLayerId);
				}
				if (map.getSource(orbitSourceId)) {
					map.removeSource(orbitSourceId);
				}
				if (map.getLayer(planetLayerId)) {
					map.removeLayer(planetLayerId);
				}
				if (map.getSource(planetSourceId)) {
					map.removeSource(planetSourceId);
				}
				if (map.getLayer(labelLayerId)) {
					map.removeLayer(labelLayerId);
				}
				if (map.getSource(labelSourceId)) {
					map.removeSource(labelSourceId);
				}
			});

			// å„æƒ‘æ˜Ÿã®è»Œé“ã¨æƒ‘æ˜Ÿæœ¬ä½“ã‚’æç”»
			PLANETS.forEach(planet => {
				// è»Œé“åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
				const orbitRadiusMeters = planet.orbitAU * oneAUInMeters;

				// è»Œé“åŠå¾„ã‚’ã‚­ãƒ­ãƒ¡ãƒ¼ãƒˆãƒ«ã«å¤‰æ›ï¼ˆTurf.jsã¯kmã‚’ä½¿ç”¨ï¼‰
				const orbitRadiusKm = orbitRadiusMeters / 1000;

				// è»Œé“åŠå¾„ãŒ20,000kmã‚’è¶…ãˆã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã€æƒ…å ±ã‚’è¨˜éŒ²
				if (orbitRadiusKm > 20000) {
					// åœ°çƒã®å††å‘¨ï¼ˆèµ¤é“å‘¨å›²ï¼‰: ç´„40,075km
					const earthCircumference = 40075;
					const timesAroundEarth = orbitRadiusKm / earthCircumference;
					console.log(`${planet.name}: è»Œé“ ${orbitRadiusKm.toFixed(2)} km (åœ°çƒ${timesAroundEarth.toFixed(2)}å‘¨åˆ†) - è¡¨ç¤ºç¯„å›²å¤–ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—`);

					// ç¯„å›²å¤–ã®å¤©ä½“æƒ…å ±ã‚’ä¿å­˜
					window.outOfRangePlanets.push({
						name: planet.name,
						color: planet.color,
						distanceKm: orbitRadiusKm,
						timesAroundEarth: timesAroundEarth
					});

					return;
				}

				// æƒ‘æ˜Ÿã®ç›´å¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰ã‚’è¨ˆç®—
				const planetDiameterMeters = planet.diameterKm > 0 ? (planet.diameterKm * 100000 * scale) / 100 : 0;
				const planetRadiusKm = (planetDiameterMeters / 2) / 1000;

				let orbitCircle;
				let planetPosition;

				// æ¥•å††è»Œé“ã‚’æŒã¤å¤©ä½“ï¼ˆæƒ‘æ˜Ÿã€æº–æƒ‘æ˜Ÿã€å½—æ˜Ÿï¼‰ã®å ´åˆã¯æ¥•å††è»Œé“ã‚’ç”Ÿæˆ
				if (planet.eccentricity && planet.eccentricity > 0) {
					// æ¥•å††ã®é•·åŠå¾„ã¨çŸ­åŠå¾„ã‚’è¨ˆç®—
					const semiMajorAxisKm = orbitRadiusKm;
					const semiMinorAxisKm = semiMajorAxisKm * Math.sqrt(1 - planet.eccentricity * planet.eccentricity);

					// æ¥•å††ã®ä¸­å¿ƒï¼ˆå¤ªé™½ã¯ç„¦ç‚¹ã®1ã¤ï¼‰
					const focalDistanceKm = semiMajorAxisKm * planet.eccentricity;

					// è¿‘æ—¥ç‚¹è§’åº¦ï¼ˆåº¦ã‹ã‚‰ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›ï¼‰
					const perihelionAngleRad = (planet.perihelionAngleDeg || 0) * Math.PI / 180;

					// æ¥•å††ã®ä¸­å¿ƒåº§æ¨™ã‚’è¨ˆç®—ï¼ˆå¤ªé™½ã‹ã‚‰ç„¦ç‚¹è·é›¢åˆ†ç§»å‹•ï¼‰
					const ellipseCenter = turf.destination(
						sunCoordinates,
						focalDistanceKm,
						90 + planet.perihelionAngleDeg,
						{ units: 'kilometers' }
					);

					// æ¥•å††ã‚’ç”Ÿæˆï¼ˆTurf.jsã®ellipseé–¢æ•°ã‚’ä½¿ç”¨ï¼‰
					orbitCircle = turf.ellipse(
						ellipseCenter.geometry.coordinates,
						semiMajorAxisKm,
						semiMinorAxisKm,
						{
							steps: 128,
							units: 'kilometers',
							angle: planet.perihelionAngleDeg || 0
						}
					);

					// å¤©ä½“ã®ä½ç½®ã‚’è»Œé“ä¸Šã®æŒ‡å®šè§’åº¦ã«é…ç½®ï¼ˆæ¥•å††è»Œé“ä¸Šã®çœŸè¿‘ç‚¹é›¢è§’ã‚’è€ƒæ…®ï¼‰
					const orbitAngle = planet.orbitAngleDeg || 0;
					// æ¥•å††è»Œé“ä¸Šã®è·é›¢ã‚’è¨ˆç®—ï¼ˆè¿‘ä¼¼ï¼‰
					const e = planet.eccentricity;
					const a = orbitRadiusKm;
					const theta = (orbitAngle * Math.PI / 180);
					const r = (a * (1 - e * e)) / (1 + e * Math.cos(theta));

					planetPosition = turf.destination(
						sunCoordinates,
						r,
						90 + (planet.perihelionAngleDeg || 0) + orbitAngle,
						{ units: 'kilometers' }
					);
				} else {
					// é€šå¸¸ã®å††è»Œé“ã‚’ç”Ÿæˆ
					orbitCircle = turf.circle(sunCoordinates, orbitRadiusKm, {
						steps: 128,
						units: 'kilometers'
					});

					// æƒ‘æ˜Ÿã®ä½ç½®ã‚’è»Œé“ä¸Šã®æŒ‡å®šè§’åº¦ã«é…ç½®
					const orbitAngle = planet.orbitAngleDeg || 90;
					planetPosition = turf.destination(sunCoordinates, orbitRadiusKm, orbitAngle, { units: 'kilometers' });
				}

				const orbitSourceId = `orbit-source-${planet.name}`;
				const orbitLayerId = `orbit-${planet.name}`;
				const planetSourceId = `planet-source-${planet.name}`;
				const planetLayerId = `planet-${planet.name}`;

				// è»Œé“ã®ã‚½ãƒ¼ã‚¹ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
				map.addSource(orbitSourceId, {
					type: 'geojson',
					data: orbitCircle
				});

				// è»Œé“ã®ç·šå¹…ã¨é€æ˜åº¦ã‚’ç¨®åˆ¥ã«ã‚ˆã£ã¦èª¿æ•´
				const lineWidth = planet.type === 'region' ? 2 : (planet.type === 'star' ? 3 : (planet.type === 'comet' ? 3 : 4));
				const lineOpacity = planet.type === 'region' ? 0.3 : (planet.type === 'star' ? 0.5 : (planet.type === 'comet' ? 0.5 : 0.6));
				const lineDasharray = planet.type === 'region' ? [5, 5] : (planet.type === 'star' ? [10, 10] : (planet.type === 'comet' ? [8, 4] : null));
				const layerPaint = {
					'line-color': planet.color,
					'line-width': lineWidth,
					'line-opacity': lineOpacity
				};
				if (lineDasharray) {
					layerPaint['line-dasharray'] = lineDasharray;
				}

				map.addLayer({
					id: orbitLayerId,
					type: 'line',
					source: orbitSourceId,
					paint: layerPaint
				});

				// è»Œé“ç·šã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
				map.on('click', orbitLayerId, (e) => {
					const coordinates = e.lngLat;
					const distanceKm = planet.orbitAU * AU_IN_KM;
					const travelTime = calculateTravelTime(distanceKm);

					let orbitInfo = '';
					if (planet.eccentricity && planet.eccentricity > 0) {
						const aphelionAU = planet.orbitAU * (1 + planet.eccentricity);
						orbitInfo = `
					<p style="margin: 5px 0;"><strong>è»Œé“é•·åŠå¾„:</strong> ${planet.orbitAU.toFixed(3)} AU</p>
					<p style="margin: 5px 0;"><strong>é›¢å¿ƒç‡:</strong> ${planet.eccentricity.toFixed(3)}</p>
					<p style="margin: 5px 0;"><strong>è¿‘æ—¥ç‚¹è·é›¢:</strong> ${planet.perihelionAU.toFixed(3)} AU</p>
					<p style="margin: 5px 0;"><strong>é æ—¥ç‚¹è·é›¢:</strong> ${aphelionAU.toFixed(3)} AU</p>
				`;
					} else {
						orbitInfo = `
					<p style="margin: 5px 0;"><strong>è»Œé“åŠå¾„:</strong> ${planet.orbitAU.toFixed(2)} AU</p>
					<p style="margin: 5px 0;"><strong>å®Ÿéš›ã®è·é›¢:</strong> ${(distanceKm / 100000000).toFixed(2)} å„„km</p>
				`;
					}

					const popupContent = `
				<div style="font-family: 'Segoe UI', sans-serif; min-width: 250px;">
					<h3 style="margin: 0 0 10px 0; color: ${planet.color}; font-size: 16px;">
						${planet.name}
					</h3>
					<div style="font-size: 13px; line-height: 1.6;">
						${orbitInfo}
						<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
						<p style="margin: 5px 0; font-weight: bold; color: #333;">ğŸš€ åˆ°é”æ™‚é–“:</p>
						<p style="margin: 3px 0 3px 15px;">ğŸ’¡ å…‰é€Ÿ: <strong>${travelTime.light}</strong></p>
						<p style="margin: 3px 0 3px 15px;">ğŸš„ æ–°å¹¹ç·š: <strong>${travelTime.shinkansen}</strong></p>
						<p style="margin: 3px 0 3px 15px;">ğŸš¶ å¾’æ­©: <strong>${travelTime.walking}</strong></p>
						<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
						<p style="margin: 5px 0;">
							<a href="https://www.google.com/maps?q=${coordinates.lat},${coordinates.lng}" 
							   target="_blank" 
							   style="color: #4CAF50; text-decoration: none;">
								ğŸ“ Google Mapsã§ã“ã®å ´æ‰€ã‚’è¦‹ã‚‹
							</a>
						</p>
					</div>
				</div>
			`;

					new maplibregl.Popup({
						maxWidth: '350px'
					})
						.setLngLat(coordinates)
						.setHTML(popupContent)
						.addTo(map);
				});

				// ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã«å¤‰æ›´
				map.on('mouseenter', orbitLayerId, () => {
					map.getCanvas().style.cursor = 'pointer';
				});

				map.on('mouseleave', orbitLayerId, () => {
					map.getCanvas().style.cursor = '';
				});

				// æƒ‘æ˜Ÿã®ã‚½ãƒ¼ã‚¹ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ï¼ˆå¡—ã‚Šã¤ã¶ã—å††ã¨ã—ã¦æç”»ï¼‰
				// é ˜åŸŸã‚„æ’æ˜Ÿï¼ˆç›´å¾„0ï¼‰ã¯æƒ‘æ˜Ÿæœ¬ä½“ã‚’æç”»ã—ãªã„
				if (planet.diameterKm > 0) {
					// æƒ‘æ˜Ÿæœ¬ä½“ã®å††ã‚’ç”Ÿæˆ
					const planetCircle = turf.circle(planetPosition.geometry.coordinates, planetRadiusKm, {
						steps: 64,
						units: 'kilometers'
					});

					map.addSource(planetSourceId, {
						type: 'geojson',
						data: planetCircle
					});

					map.addLayer({
						id: planetLayerId,
						type: 'fill',
						source: planetSourceId,
						paint: {
							'fill-color': planet.color,
							'fill-opacity': 0.8
						}
					});

					// æƒ‘æ˜Ÿæœ¬ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
					map.on('click', planetLayerId, (e) => {
						const coordinates = e.lngLat;
						const distanceKm = planet.orbitAU * AU_IN_KM;
						const travelTime = calculateTravelTime(distanceKm);

						const popupContent = `
			<div style="font-family: 'Segoe UI', sans-serif; min-width: 250px;">
				<h3 style="margin: 0 0 10px 0; color: ${planet.color}; font-size: 16px;">
					${planet.name}
				</h3>
				<div style="font-size: 13px; line-height: 1.6;">
					<p style="margin: 5px 0;"><strong>å®Ÿéš›ã®ç›´å¾„:</strong> ${planet.diameterKm.toLocaleString()} km</p>
					<p style="margin: 5px 0;"><strong>è»Œé“åŠå¾„:</strong> ${planet.orbitAU.toFixed(2)} AU</p>
					<p style="margin: 5px 0;"><strong>å¤ªé™½ã‹ã‚‰ã®è·é›¢:</strong> ${(distanceKm / 100000000).toFixed(2)} å„„km</p>
					<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
					<p style="margin: 5px 0; font-weight: bold; color: #333;">ğŸš€ å¤ªé™½ã‹ã‚‰ã®åˆ°é”æ™‚é–“:</p>
					<p style="margin: 3px 0 3px 15px;">ğŸ’¡ å…‰é€Ÿ: <strong>${travelTime.light}</strong></p>
					<p style="margin: 3px 0 3px 15px;">ğŸš„ æ–°å¹¹ç·š: <strong>${travelTime.shinkansen}</strong></p>
					<p style="margin: 3px 0 3px 15px;">ğŸš¶ å¾’æ­©: <strong>${travelTime.walking}</strong></p>
					<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
					<p style="margin: 5px 0;">
						<a href="https://www.google.com/maps?q=${coordinates.lat},${coordinates.lng}" 
						   target="_blank" 
						   style="color: #4CAF50; text-decoration: none;">
							ğŸ“ Google Mapsã§ã“ã®å ´æ‰€ã‚’è¦‹ã‚‹
						</a>
					</p>
				</div>
			</div>
		`;

						new maplibregl.Popup({
							maxWidth: '350px'
						})
							.setLngLat(coordinates)
							.setHTML(popupContent)
							.addTo(map);
					});

					// ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã«å¤‰æ›´
					map.on('mouseenter', planetLayerId, () => {
						map.getCanvas().style.cursor = 'pointer';
					});

					map.on('mouseleave', planetLayerId, () => {
						map.getCanvas().style.cursor = '';
					});
				}

				// æƒ‘æ˜Ÿãƒ©ãƒ™ãƒ«ã®è¿½åŠ ï¼ˆå…¨ã¦ã®å¤©ä½“ã«å¯¾ã—ã¦ï¼‰
				const labelSourceId = `label-source-${planet.name}`;
				const labelLayerId = `label-${planet.name}`;

				// ãƒ©ãƒ™ãƒ«ç”¨ã®ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆ
				const labelPoint = turf.point(planetPosition.geometry.coordinates, {
					name: planet.name
				});

				map.addSource(labelSourceId, {
					type: 'geojson',
					data: labelPoint
				});

				// ãƒ©ãƒ™ãƒ«ã‚µã‚¤ã‚ºã‚’å¤©ä½“ã®ç¨®é¡ã«ã‚ˆã£ã¦èª¿æ•´
				const textSize = planet.type === 'star' ? 16 : (planet.type === 'region' ? 14 : (planet.type === 'dwarf' ? 18 : (planet.type === 'comet' ? 16 : 20)));
				map.addLayer({
					id: labelLayerId,
					type: 'symbol',
					source: labelSourceId,
					layout: {
						'text-field': ['get', 'name'],
						'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
						'text-size': textSize,
						'text-offset': [0, -2.5],
						'text-anchor': 'bottom'
					},
					paint: {
						'text-color': planet.color,
						'text-halo-color': '#ffffff',
						'text-halo-width': 3
					}
				});

				console.log(`${planet.name}: è»Œé“ ${orbitRadiusMeters.toFixed(2)} m, ç›´å¾„ ${planetDiameterMeters.toFixed(4)} m`);
			});

			// ç¯„å›²å¤–ã®å¤©ä½“ãƒªã‚¹ãƒˆã‚’æ›´æ–°
			updateOutOfRangeList();
		}

		// ========== æç”»ç¯„å›²å¤–ã®å¤©ä½“ãƒªã‚¹ãƒˆã‚’æ›´æ–° ==========
		function updateOutOfRangeList() {
			const listElement = document.getElementById('outOfRangeList');

			if (!window.outOfRangePlanets || window.outOfRangePlanets.length === 0) {
				listElement.innerHTML = '<div class="out-of-range-empty">ã™ã¹ã¦ã®å¤©ä½“ãŒè¡¨ç¤ºç¯„å›²å†…ã§ã™</div>';
				return;
			}

			let html = '';
			window.outOfRangePlanets.forEach(planet => {
				html += `<div class="out-of-range-item" style="border-left-color: ${planet.color};">`;
				html += `<strong>${planet.name}</strong><br>`;
				html += `è·é›¢: ${planet.distanceKm.toLocaleString('ja-JP', { maximumFractionDigits: 0 })} km<br>`;
				html += `åœ°çƒ <strong>${planet.timesAroundEarth.toFixed(1)}</strong> å‘¨åˆ†`;
				html += `</div>`;
			});

			listElement.innerHTML = html;
		}

		// ========== åœ°å›³ã‚¹ã‚¿ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆ ==========
		function changeMapStyle() {
			const selectedStyle = document.getElementById('mapStyle').value;

			// ç¾åœ¨ã®è»Œé“ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
			const orbitsData = {};
			PLANETS.forEach(planet => {
				const orbitSourceId = `orbit-source-${planet.name}`;
				const planetSourceId = `planet-source-${planet.name}`;
				const labelSourceId = `label-source-${planet.name}`;

				if (map.getSource(orbitSourceId)) {
					orbitsData[`orbit-${planet.name}`] = map.getSource(orbitSourceId)._data;
				}
				if (map.getSource(planetSourceId)) {
					orbitsData[`planet-${planet.name}`] = map.getSource(planetSourceId)._data;
				}
				if (map.getSource(labelSourceId)) {
					orbitsData[`label-${planet.name}`] = map.getSource(labelSourceId)._data;
				}
			});

			// ç¾åœ¨ã®ä¸­å¿ƒåº§æ¨™ã¨ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’ä¿å­˜
			const currentCenter = map.getCenter();
			const currentZoom = map.getZoom();
			const currentSunCoords = sunCoordinates;

			// åœ°å›³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
			map.setStyle(MAP_STYLES[selectedStyle]);

			// ã‚¹ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«è»Œé“ã‚’å†æç”»
			map.once('styledata', () => {
				// ä¸­å¿ƒåº§æ¨™ã¨ã‚ºãƒ¼ãƒ ã‚’å¾©å…ƒ
				map.setCenter(currentCenter);
				map.setZoom(currentZoom);

				// å¤ªé™½ã®ä½ç½®ã‚’å¾©å…ƒ
				sunCoordinates = currentSunCoords;
				if (sunMarker) {
					sunMarker.setLngLat(sunCoordinates);
				}

				// è»Œé“ã‚’å†æç”»
				if (Object.keys(orbitsData).length > 0) {
					updateOrbits();
				}
			});
		}

		// ========== å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ ==========
		function toggleFullscreen() {
			if (!document.fullscreenElement) {
				// å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
				document.documentElement.requestFullscreen().catch(err => {
					alert(`å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã§ãã¾ã›ã‚“ã§ã—ãŸ: ${err.message}`);
				});
			} else {
				// å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
				if (document.exitFullscreen) {
					document.exitFullscreen();
				}
			}
		}

		// å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã®å¤‰åŒ–ã‚’ç›£è¦–ã—ã¦ãƒœã‚¿ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
		document.addEventListener('fullscreenchange', () => {
			const btn = document.querySelector('.fullscreen-btn');
			if (document.fullscreenElement) {
				btn.textContent = 'âŒ'; // å…¨ç”»é¢ä¸­ã¯çµ‚äº†ã‚¢ã‚¤ã‚³ãƒ³
				btn.title = 'å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†';
			} else {
				btn.textContent = 'â›¶'; // é€šå¸¸æ™‚ã¯å…¨ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³
				btn.title = 'å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰';
			}
		});

		// ========== ç¾åœ¨åœ°ã‚’å¤ªé™½ã®ä¸­å¿ƒã«ã™ã‚‹ ==========
		function setCurrentLocation() {
			const locationBtn = document.querySelector('.location-btn');

			if (!navigator.geolocation) {
				alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±æ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
				return;
			}

			// ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
			locationBtn.disabled = true;
			locationBtn.textContent = 'ğŸ“¡';

			navigator.geolocation.getCurrentPosition(
				// æˆåŠŸæ™‚
				(position) => {
					const { latitude, longitude } = position.coords;

					// å¤ªé™½ã®ä½ç½®ã‚’ç¾åœ¨åœ°ã«æ›´æ–°
					sunCoordinates = [longitude, latitude];

					// å¤ªé™½ãƒãƒ¼ã‚«ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°
					if (sunMarker) {
						sunMarker.setLngLat(sunCoordinates);
					}

					// åœ°å›³ã®ä¸­å¿ƒã‚’ç¾åœ¨åœ°ã«ç§»å‹•
					map.flyTo({
						center: sunCoordinates,
						zoom: 14,
						duration: 2000
					});

					// è»Œé“ã‚’å†æç”»
					updateOrbits();

					// ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
					locationBtn.disabled = false;
					locationBtn.textContent = 'ğŸ“';
				},
				// ã‚¨ãƒ©ãƒ¼æ™‚
				(error) => {
					let errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';

					switch (error.code) {
						case error.PERMISSION_DENIED:
							errorMessage = 'ä½ç½®æƒ…å ±ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
							break;
						case error.POSITION_UNAVAILABLE:
							errorMessage = 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
							break;
						case error.TIMEOUT:
							errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚';
							break;
					}

					alert(errorMessage);

					// ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
					locationBtn.disabled = false;
					locationBtn.textContent = 'ğŸ“';
				},
				// ã‚ªãƒ—ã‚·ãƒ§ãƒ³
				{
					enableHighAccuracy: true,
					timeout: 10000,
					maximumAge: 0
				}
			);
		}

		// ========== ãƒ‘ãƒãƒ«ã®æŠ˜ã‚ŠãŸãŸã¿ ==========
		function togglePanel(contentId) {
			const content = document.getElementById(contentId);
			const button = event.target;

			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				content.style.maxHeight = content.scrollHeight + 'px';
				button.textContent = 'â–¼';
			} else {
				content.style.maxHeight = content.scrollHeight + 'px';
				setTimeout(() => {
					content.classList.add('collapsed');
				}, 10);
				button.textContent = 'â–¶';
			}
		}

		// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å„ãƒ‘ãƒãƒ«ã®åˆæœŸmaxHeightã‚’è¨­å®š
		window.addEventListener('load', () => {
			init();

			// å„ãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆæœŸmaxHeightã‚’è¨­å®š
			['controlContent', 'outOfRangeContent', 'legendContent'].forEach(id => {
				const element = document.getElementById(id);
				if (element) {
					element.style.maxHeight = element.scrollHeight + 'px';
				}
			});
		});
	</script>
</body>

</html>